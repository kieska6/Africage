import{r as a,g as P,u as $,b as I,s as c,j as e,L,U as k,a as D,B as q}from"./index-s1Im0gGd.js";import{I as M}from"./Input-BKp795_O.js";import{A}from"./Alert-DQovq92X.js";import{S as b}from"./server-crash-DZrP2UOO.js";import{S as B}from"./send-D965yodK.js";function T(r){const t=a.useRef(null),x=()=>{var o;(o=t.current)==null||o.scrollIntoView({behavior:"smooth"})};return a.useEffect(()=>{x()},[r]),{messagesEndRef:t}}function J(){const{conversationId:r}=P(),{user:t}=$(),x=I(),[o,v]=a.useState([]),[u,w]=a.useState(null),[l,h]=a.useState(""),[_,g]=a.useState(!0),[d,f]=a.useState(""),y=a.useRef(null),[p,E]=a.useState(null);T(o);const S=async()=>{if(!(!r||!t)){g(!0),f("");try{const{data:s,error:i}=await c.from("conversations").select(`
          sender_id,
          traveler_id,
          shipment:shipments(title),
          sender:users!conversations_sender_id_fkey(id, first_name, last_name, profile_picture),
          traveler:users!conversations_traveler_id_fkey(id, first_name, last_name, profile_picture)
        `).eq("id",r).single();if(i)throw i;if(!s)throw new Error("Conversation non trouvée");const n={sender_id:s.sender_id,traveler_id:s.traveler_id,shipment:s.shipment[0],sender:s.sender[0],traveler:s.traveler[0]};if(w(n),E({sender:s.sender[0],traveler:s.traveler[0]}),!(s.sender_id===t.id||s.traveler_id===t.id))throw new Error("Vous n'êtes pas autorisé à accéder à cette conversation");const{data:R,error:N}=await c.from("messages").select("*").eq("conversation_id",r).order("created_at",{ascending:!0});if(N)throw N;v(R||[])}catch(s){f(s.message||"Erreur lors du chargement de la conversation"),console.error("Error fetching chat data:",s)}finally{g(!1)}}};a.useEffect(()=>{S()},[r,t]),a.useEffect(()=>{if(!r||!t)return;const s=c.channel(`chat:${r}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${r}`},i=>{v(n=>[...n,i.new])}).subscribe();return()=>{c.removeChannel(s)}},[r,t]);const C=async s=>{if(s.preventDefault(),!l.trim()||!t||!r)return;const i=l.trim();h("");try{const{error:n}=await c.from("messages").insert({conversation_id:r,sender_id:t.id,content:i});if(n)throw n}catch(n){console.error("Error sending message:",n),f("Erreur lors de l'envoi du message"),h(i)}};if(_)return e.jsx("div",{className:"flex justify-center items-center h-[calc(100vh-4rem)]",children:e.jsx(L,{className:"w-12 h-12 text-primary animate-spin"})});if(d)return e.jsxs("div",{className:"min-h-screen bg-neutral-50 py-12 px-4 text-center",children:[e.jsx(b,{className:"w-12 h-12 text-red-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-red-700",children:"Erreur"}),e.jsx("p",{className:"text-red-600 mt-2",children:d}),e.jsx("button",{onClick:()=>x("/messages"),className:"mt-4 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90",children:"Retour aux messages"})]});if(!u||!p)return e.jsxs("div",{className:"min-h-screen bg-neutral-50 py-12 px-4 text-center",children:[e.jsx(b,{className:"w-12 h-12 text-red-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-red-700",children:"Conversation non trouvée"}),e.jsx("p",{className:"text-red-600 mt-2",children:"La conversation que vous recherchez n'existe pas."})]});const m=(t==null?void 0:t.id)===u.sender_id?p.traveler:p.sender,j=`${m.first_name} ${m.last_name}`;return e.jsx("div",{className:"min-h-screen bg-neutral-50 py-12 px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsx("div",{className:"bg-white rounded-4xl shadow-xl p-6 mb-6",children:e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center",children:[m.profile_picture?e.jsx("img",{src:m.profile_picture,alt:j,className:"w-10 h-10 rounded-full object-cover mr-3"}):e.jsx("div",{className:"w-10 h-10 rounded-full bg-neutral-200 flex items-center justify-center mr-3",children:e.jsx(k,{className:"w-6 h-6 text-neutral-500"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"font-bold text-neutral-800",children:j}),e.jsx("p",{className:"text-sm text-neutral-600",children:u.shipment.title})]})]}),e.jsx(D,{to:"/messages",className:"text-primary hover:text-primary/80",children:"Retour"})]})}),e.jsxs("div",{className:"bg-white rounded-4xl shadow-xl p-6",children:[e.jsxs("div",{className:"flex-1 overflow-y-auto max-h-96 space-y-4 mb-6",children:[o.map(s=>e.jsx("div",{className:`flex ${s.sender_id===(t==null?void 0:t.id)?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-xs md:max-w-md px-4 py-3 rounded-2xl ${s.sender_id===(t==null?void 0:t.id)?"bg-accent text-white rounded-br-lg":"bg-neutral-100 text-neutral-800 rounded-bl-lg"}`,children:[e.jsx("p",{className:"break-words",children:s.content}),e.jsx("p",{className:`text-xs mt-1 ${s.sender_id===(t==null?void 0:t.id)?"text-accent/80":"text-neutral-500"}`,children:new Date(s.created_at).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})})]})},s.id)),e.jsx("div",{ref:y})]}),d&&e.jsx(A,{type:"error",message:d,className:"mb-4"}),e.jsxs("form",{onSubmit:C,className:"flex items-center gap-4",children:[e.jsx(M,{type:"text",value:l,onChange:s=>h(s.target.value),placeholder:"Écrivez votre message...",className:"flex-1",autoComplete:"off"}),e.jsx(q,{type:"submit",disabled:!l.trim(),className:"h-12 w-12 p-0",children:e.jsx(B,{className:"w-5 h-5"})})]})]})]})})}export{J as ChatPage};
