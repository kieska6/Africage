import{g as D,u as A,r as a,j as e,L as P,U as C,a as g,s as x}from"./index-s1Im0gGd.js";import{A as w}from"./Alert-DQovq92X.js";import{L as I}from"./LeaveReviewForm-giRhknTP.js";import{S as M}from"./server-crash-DZrP2UOO.js";import{W as U}from"./weight-h7E0NLn2.js";import{R as k}from"./ruler-DCue6X6r.js";import{M as q}from"./map-pin-CGMQsRrg.js";import"./star-28KIeG3b.js";function W(){const{id:n}=D(),{user:t}=A(),[s,b]=a.useState(null),[_,u]=a.useState(!0),[h,p]=a.useState(null),[f,y]=a.useState([]),[v,S]=a.useState(!1),[j,E]=a.useState(null);if(a.useEffect(()=>{(async()=>{if(n)try{u(!0),p(null);const{data:i,error:l}=await x.from("shipments").select("*, sender:users!sender_id(first_name, last_name, profile_picture)").eq("id",n).single();if(l)throw l;if(!i)throw new Error("Annonce non trouvée");b(i);const{data:c,error:N}=await x.from("reviews").select("*, reviewer:users!reviews_reviewer_id_fkey(first_name, last_name)").eq("transaction_id",n);if(N)throw N;if(y(c),t){const d=c==null?void 0:c.some(m=>m.reviewer_id===t.id);S(!!d)}if(t){const{data:d,error:m}=await x.from("conversations").select("*").eq("shipment_id",n).in("sender_id",[t.id]).single();!m&&d&&E(d)}}catch(i){p("Impossible de charger les détails de l'annonce."),console.error(i)}finally{u(!1)}})()},[n,t]),_)return e.jsx("div",{className:"flex justify-center items-center min-h-screen",children:e.jsx(P,{className:"w-12 h-12 text-primary animate-spin"})});if(h)return e.jsxs("div",{className:"min-h-screen bg-neutral-50 py-12 px-4 sm:px-6 lg:px-8 text-center",children:[e.jsx(M,{className:"w-12 h-12 text-red-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-red-700",children:"Une erreur est survenue"}),e.jsx("p",{className:"text-red-600 mt-2",children:h})]});if(!s)return e.jsx("div",{className:"text-center py-20",children:"Annonce non trouvée."});const o=t&&s.status==="COMPLETED"&&!v&&t.id===s.sender_id,L=t&&(s.status==="IN_TRANSIT"||s.status==="COMPLETED")&&t.id===s.sender_id,R=r=>new Date(r).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"});return e.jsx("div",{className:"min-h-screen bg-neutral-50 py-12 px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"max-w-4xl mx-auto",children:e.jsxs("div",{className:"bg-white rounded-4xl shadow-xl p-8",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl md:text-4xl font-bold text-neutral-800",children:s.title}),e.jsxs("p",{className:"text-neutral-500 mt-2",children:["Publié le ",new Date(s.created_at).toLocaleDateString("fr-FR")]})]}),e.jsxs("div",{className:"mt-4 md:mt-0 text-2xl font-bold text-green-600",children:[s.proposed_price.toLocaleString()," ",s.currency]})]}),e.jsxs("div",{className:"grid md:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"md:col-span-2 space-y-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-neutral-800 mb-2",children:"Description"}),e.jsx("p",{className:"text-neutral-600 leading-relaxed",children:s.description||"Aucune description fournie."})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-neutral-800 mb-4",children:"Détails du colis"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-neutral-700",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(U,{className:"w-5 h-5 mr-2 text-accent"})," Poids: ",e.jsxs("strong",{children:[s.weight," kg"]})]}),s.length&&e.jsxs("div",{className:"flex items-center",children:[e.jsx(k,{className:"w-5 h-5 mr-2 text-accent"})," Dimensions: ",e.jsxs("strong",{children:[s.length,"x",s.width,"x",s.height," cm"]})]})]})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-neutral-800 mb-4",children:"Itinéraire"}),e.jsxs("div",{className:"flex items-center text-neutral-700",children:[e.jsx(q,{className:"w-5 h-5 mr-2 text-accent"}),"De ",e.jsx("strong",{children:s.pickup_city})," à ",e.jsx("strong",{children:s.delivery_city})]})]}),f.length>0&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-semibold text-neutral-800 mb-4",children:"Avis sur cet envoi"}),e.jsx("div",{className:"space-y-4",children:f.map(r=>e.jsxs("div",{className:"bg-neutral-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("p",{className:"font-semibold",children:[r.reviewer.first_name," ",r.reviewer.last_name]}),e.jsx("div",{className:"flex items-center",children:[...Array(5)].map((i,l)=>e.jsx("svg",{className:`w-4 h-4 ${l<r.rating?"text-yellow-400 fill-current":"text-neutral-300"}`,viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{d:"M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"})},l))})]}),e.jsxs("p",{className:"text-neutral-600 italic",children:['"',r.comment,'"']}),e.jsx("p",{className:"text-xs text-neutral-500 mt-2",children:R(r.created_at)})]},r.id))})]})]}),e.jsxs("div",{className:"md:col-span-1 space-y-6",children:[e.jsxs("div",{className:"bg-neutral-50 rounded-2xl p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-neutral-800 mb-4 text-center",children:"Expéditeur"}),e.jsxs("div",{className:"flex flex-col items-center text-center",children:[s.sender&&s.sender.profile_picture?e.jsx("img",{src:s.sender.profile_picture,alt:"Expéditeur",className:"w-20 h-20 rounded-full mb-3"}):e.jsx("div",{className:"w-20 h-20 rounded-full bg-neutral-200 flex items-center justify-center mx-auto mb-3",children:e.jsx(C,{className:"w-10 h-10 text-neutral-500"})}),e.jsx(g,{to:`/users/${s.sender_id}`,className:"font-bold text-neutral-900 hover:text-accent transition-colors",children:s.sender?`${s.sender.first_name} ${s.sender.last_name}`:"Utilisateur inconnu"})]})]}),L&&j&&e.jsx(g,{to:`/messages/${j.id}`,className:"block bg-primary text-white text-center py-3 px-4 rounded-2xl hover:bg-primary/90 transition-colors font-semibold",children:"Voir la conversation"})]})]}),o&&e.jsxs("div",{className:"mt-8 pt-8 border-t border-neutral-200",children:[e.jsx("h3",{className:"text-2xl font-semibold text-neutral-800 mb-6",children:"Laisser un avis"}),e.jsx(I,{transactionId:s.id,revieweeId:s.sender_id,reviewerId:t.id,onReviewSubmitted:()=>{window.location.reload()}})]}),!o&&t&&s.status!=="COMPLETED"&&e.jsx("div",{className:"mt-8 pt-8 border-t border-neutral-200",children:e.jsx(w,{type:"info",message:"Vous ne pouvez laisser un avis que lorsque l'envoi est terminé."})}),!o&&t&&v&&e.jsx("div",{className:"mt-8 pt-8 border-t border-neutral-200",children:e.jsx(w,{type:"success",message:"Vous avez déjà laissé un avis pour cet envoi. Merci !"})})]})})})}export{W as ShipmentDetailsPage};
