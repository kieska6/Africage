import{c as I,r as a,j as e,L as N,B as f,a as g,s as h,u as v,U as L,d as D,e as P,R as A,S as O,C as R}from"./index-s1Im0gGd.js";import{S as T}from"./ShipmentCard--3z7VJzP.js";import{S as b}from"./server-crash-DZrP2UOO.js";import{P as y}from"./package-D_gg4fgx.js";import{A as E}from"./Alert-DQovq92X.js";import{C as _}from"./check-DFZLJWyg.js";import{I as q}from"./inbox-B89tADt3.js";import{M as V}from"./map-pin-CGMQsRrg.js";import{S as z}from"./send-D965yodK.js";import{B as M}from"./briefcase-DOTPYjiq.js";import{P as k}from"./plus-D0Ef-JQS.js";import{S as U}from"./star-28KIeG3b.js";import"./calendar-8PhAnDAA.js";import"./dollar-sign-CLdPlu9-.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const B=I("History",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const F=I("PlusCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]);function $(){const[s,n]=a.useState([]),[m,d]=a.useState(!0),[l,c]=a.useState(null);return a.useEffect(()=>{(async()=>{try{d(!0),c(null);const{data:t,error:r}=await h.from("shipments").select("*").order("created_at",{ascending:!1});if(r)throw r;if(console.log("Données brutes de Supabase:",t),!Array.isArray(t))throw new Error("Les données reçues ne sont pas un tableau");const o=t.filter(u=>u&&typeof u=="object"&&u.id&&u.title);console.log("Annonces valides:",o),n(o)}catch(t){console.error("Erreur lors du chargement des annonces:",t),c(t.message||"Impossible de charger vos annonces. Veuillez réessayer.")}finally{d(!1)}})()},[]),m?e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx(N,{className:"w-8 h-8 text-primary animate-spin mr-3"}),e.jsx("span",{className:"text-neutral-600",children:"Chargement de vos annonces..."})]}):l?e.jsxs("div",{className:"text-center py-12 bg-red-50 rounded-2xl",children:[e.jsx(b,{className:"w-12 h-12 text-red-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-red-700",children:"Une erreur est survenue"}),e.jsx("p",{className:"text-red-600 mt-2",children:l}),e.jsx(f,{onClick:()=>window.location.reload(),className:"mt-4",children:"Réessayer"})]}):s.length===0?e.jsxs("div",{className:"text-center py-12 bg-neutral-100 rounded-2xl",children:[e.jsx(y,{className:"w-12 h-12 text-neutral-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-neutral-700",children:"Aucune annonce pour le moment"}),e.jsx("p",{className:"text-neutral-500 mt-2 mb-6",children:"Commencez par publier votre première annonce de colis."}),e.jsx(g,{to:"/create-shipment",children:e.jsx(f,{children:"Publier une annonce"})})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8",children:s.map(i=>e.jsx(T,{shipment:i},i.id))})}function H({transaction:s,onOfferAccepted:n}){var u,x;const{user:m}=v(),[d,l]=a.useState(!1),[c,i]=a.useState(""),[t,r]=a.useState(!1),o=async()=>{if(!m){i("Vous devez être connecté pour accepter une offre.");return}l(!0),i("");try{const{error:p}=await h.from("transactions").update({status:"CONFIRMED",confirmed_at:new Date().toISOString()}).eq("id",s.id);if(p)throw p;const{error:w}=await h.from("shipments").update({status:"MATCHED"}).eq("id",s.shipment_id);if(w)throw w;const{data:j,error:C}=await h.from("conversations").insert({shipment_id:s.shipment_id,sender_id:m.id,traveler_id:s.traveler_id}).select("id").single();if(C)throw C;const{error:S}=await h.from("notifications").insert({recipient_id:s.traveler_id,type:"OFFER_ACCEPTED",related_entity_id:j.id,content:`Votre offre pour "${s.shipments.title}" a été acceptée.`});S&&console.error("Error creating notification:",S),r(!0),setTimeout(()=>{n()},1500)}catch(p){console.error("Erreur lors de l'acceptation de l'offre:",p),i("Impossible d'accepter l'offre. Veuillez réessayer.")}finally{l(!1)}};return e.jsxs("div",{className:"bg-white p-4 rounded-lg border border-neutral-200 shadow-sm transition-all hover:shadow-md",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center text-neutral-500 text-sm mb-1",children:[e.jsx(y,{className:"w-4 h-4 mr-2"}),e.jsxs("span",{children:["Offre pour : ",s.shipments.title]})]}),e.jsxs("div",{className:"flex items-center text-neutral-800 font-semibold",children:[e.jsx(L,{className:"w-4 h-4 mr-2 text-accent"}),e.jsxs("span",{children:["De la part de : ",(u=s.users)==null?void 0:u.first_name," ",(x=s.users)==null?void 0:x.last_name]})]})]}),e.jsx("div",{className:"w-full sm:w-auto",children:e.jsx(f,{onClick:o,loading:d,disabled:t,className:`w-full ${t?"bg-green-600 hover:bg-green-700":"bg-primary hover:bg-primary/90"} text-white`,children:t?e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"w-4 h-4 mr-2"}),"Acceptée !"]}):"Accepter l'offre"})})]}),c&&e.jsx(E,{type:"error",message:c,className:"mt-4"})]})}function G(){const{user:s}=v(),[n,m]=a.useState([]),[d,l]=a.useState(!0),[c,i]=a.useState(null),t=a.useCallback(async()=>{if(s)try{l(!0),i(null);const{data:r,error:o}=await h.from("transactions").select(`
          id,
          traveler_id,
          shipment_id,
          shipments ( title ),
          users!transactions_traveler_id_fkey ( first_name, last_name )
        `).eq("sender_id",s.id).eq("status","PENDING");if(o)throw o;m(r||[])}catch(r){console.error("Erreur lors de la récupération des offres:",r),i("Impossible de charger les offres reçues.")}finally{l(!1)}},[s]);return a.useEffect(()=>{t()},[t]),d?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx(N,{className:"w-6 h-6 text-primary animate-spin mr-3"}),e.jsx("span",{className:"text-neutral-600",children:"Chargement des offres..."})]}):c?e.jsxs("div",{className:"text-center py-8 bg-red-50 rounded-lg",children:[e.jsx(b,{className:"w-10 h-10 text-red-500 mx-auto mb-3"}),e.jsx("h3",{className:"text-lg font-semibold text-red-700",children:"Une erreur est survenue"}),e.jsx("p",{className:"text-red-600 mt-1",children:c})]}):n.length===0?e.jsxs("div",{className:"text-center py-8 bg-neutral-100 rounded-lg",children:[e.jsx(q,{className:"w-10 h-10 text-neutral-400 mx-auto mb-3"}),e.jsx("h3",{className:"text-lg font-semibold text-neutral-700",children:"Aucune nouvelle offre"}),e.jsx("p",{className:"text-neutral-500 mt-1",children:"Vous serez notifié ici dès que vous recevrez une proposition."})]}):e.jsx("div",{className:"space-y-4",children:n.map(r=>e.jsx(H,{transaction:r,onOfferAccepted:t},r.id))})}function W({transaction:s,onUpdate:n}){var o,u;const[m,d]=a.useState(!1),[l,c]=a.useState(""),[i,t]=a.useState(!1),r=async()=>{d(!0),c("");try{const{error:x}=await h.from("transactions").update({status:"DELIVERED"}).eq("id",s.id);if(x)throw x;t(!0),setTimeout(()=>{n()},1500)}catch(x){c("Une erreur est survenue lors de la mise à jour. Veuillez réessayer."),console.error("Error marking as delivered:",x)}finally{d(!1)}};return e.jsxs("div",{className:"bg-white p-4 rounded-lg border border-neutral-200 shadow-sm transition-all hover:shadow-md",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsxs("div",{className:"flex items-center text-neutral-800 font-semibold",children:[e.jsx(y,{className:"w-4 h-4 mr-2 text-accent"}),e.jsx("span",{children:s.shipments.title})]}),e.jsxs("div",{className:"flex items-center text-neutral-500 text-sm",children:[e.jsx(V,{className:"w-4 h-4 mr-2"}),e.jsxs("span",{children:["De ",e.jsx("strong",{children:s.shipments.pickup_city})," à ",e.jsx("strong",{children:s.shipments.delivery_city})]})]}),e.jsxs("div",{className:"flex items-center text-neutral-500 text-sm",children:[e.jsx(L,{className:"w-4 h-4 mr-2"}),e.jsxs("span",{children:["Pour : ",(o=s.users)==null?void 0:o.first_name," ",(u=s.users)==null?void 0:u.last_name]})]})]}),e.jsx("div",{className:"w-full sm:w-auto",children:e.jsx(f,{variant:"outline",className:`w-full ${i?"bg-green-50 border-green-300 text-green-700":""}`,onClick:r,loading:m,disabled:i,children:i?e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"w-4 h-4 mr-2"}),"Livré !"]}):e.jsxs(e.Fragment,{children:[e.jsx(z,{className:"w-4 h-4 mr-2"}),"Marquer comme livré"]})})})]}),l&&e.jsx(E,{type:"error",message:l,className:"mt-3"})]})}function J(){const{user:s}=v(),[n,m]=a.useState([]),[d,l]=a.useState(!0),[c,i]=a.useState(null),t=a.useCallback(async()=>{if(s)try{l(!0),i(null);const{data:r,error:o}=await h.from("transactions").select(`
          id,
          shipments ( title, pickup_city, delivery_city ),
          users!transactions_sender_id_fkey ( first_name, last_name )
        `).eq("traveler_id",s.id).eq("status","CONFIRMED");if(o)throw o;m(r||[])}catch(r){console.error("Erreur lors de la récupération des transports:",r),i("Impossible de charger vos transports à venir.")}finally{l(!1)}},[s]);return a.useEffect(()=>{t()},[t]),d?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx(N,{className:"w-6 h-6 text-primary animate-spin mr-3"}),e.jsx("span",{className:"text-neutral-600",children:"Chargement des transports..."})]}):c?e.jsxs("div",{className:"text-center py-8 bg-red-50 rounded-lg",children:[e.jsx(b,{className:"w-10 h-10 text-red-500 mx-auto mb-3"}),e.jsx("h3",{className:"text-lg font-semibold text-red-700",children:"Une erreur est survenue"}),e.jsx("p",{className:"text-red-600 mt-1",children:c})]}):n.length===0?e.jsxs("div",{className:"text-center py-8 bg-neutral-100 rounded-lg",children:[e.jsx(M,{className:"w-10 h-10 text-neutral-400 mx-auto mb-3"}),e.jsx("h3",{className:"text-lg font-semibold text-neutral-700",children:"Aucun transport à venir"}),e.jsx("p",{className:"text-neutral-500 mt-1",children:"Lorsqu'un expéditeur acceptera votre offre, le colis apparaîtra ici."})]}):e.jsx("div",{className:"space-y-4",children:n.map(r=>e.jsx(W,{transaction:r,onUpdate:t},r.id))})}function K({transaction:s,onConfirmed:n}){var o,u;const[m,d]=a.useState(!1),[l,c]=a.useState(""),[i,t]=a.useState(!1),r=async()=>{d(!0),c("");try{const{error:x}=await h.from("transactions").update({status:"COMPLETED"}).eq("id",s.id);if(x)throw x;const{error:p}=await h.from("shipments").update({status:"DELIVERED"}).eq("id",s.shipment_id);if(p)throw p;t(!0),setTimeout(()=>{n()},1500)}catch(x){console.error("Erreur lors de la confirmation de la réception:",x),c("Impossible de confirmer la réception. Veuillez réessayer.")}finally{d(!1)}};return e.jsxs("div",{className:"bg-white p-4 rounded-lg border border-neutral-200 shadow-sm",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("p",{className:"text-neutral-700",children:["Le colis ",e.jsxs("strong",{className:"font-semibold text-neutral-900",children:['"',s.shipments.title,'"']})," a été marqué comme livré par ",e.jsxs("strong",{className:"font-semibold text-neutral-900",children:[(o=s.users)==null?void 0:o.first_name," ",(u=s.users)==null?void 0:u.last_name]}),"."]})}),e.jsx("div",{className:"w-full sm:w-auto",children:e.jsx(f,{onClick:r,loading:m,disabled:i,className:`w-full ${i?"bg-green-600 hover:bg-green-700":"bg-primary hover:bg-primary/90"} text-white`,children:i?e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"w-4 h-4 mr-2"}),"Confirmé !"]}):"Confirmer la réception"})})]}),l&&e.jsx(E,{type:"error",message:l,className:"mt-4"})]})}function Q(){const{user:s}=v(),[n,m]=a.useState([]),[d,l]=a.useState(!0),[c,i]=a.useState(null),t=a.useCallback(async()=>{if(s)try{l(!0),i(null);const{data:r,error:o}=await h.from("transactions").select(`
          id,
          shipment_id,
          shipments ( title ),
          users!transactions_traveler_id_fkey ( first_name, last_name )
        `).eq("sender_id",s.id).eq("status","DELIVERED");if(o)throw o;m(r||[])}catch(r){console.error("Erreur lors de la récupération des confirmations:",r),i("Impossible de charger les confirmations en attente.")}finally{l(!1)}},[s]);return a.useEffect(()=>{t()},[t]),d?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx(N,{className:"w-6 h-6 text-primary animate-spin mr-3"}),e.jsx("span",{className:"text-neutral-600",children:"Chargement..."})]}):c?e.jsxs("div",{className:"text-center py-8 bg-red-50 rounded-lg",children:[e.jsx(b,{className:"w-10 h-10 text-red-500 mx-auto mb-3"}),e.jsx("h3",{className:"text-lg font-semibold text-red-700",children:"Une erreur est survenue"}),e.jsx("p",{className:"text-red-600 mt-1",children:c})]}):n.length===0?e.jsxs("div",{className:"text-center py-8 bg-neutral-100 rounded-lg",children:[e.jsx(D,{className:"w-10 h-10 text-neutral-400 mx-auto mb-3"}),e.jsx("h3",{className:"text-lg font-semibold text-neutral-700",children:"Aucune confirmation en attente"}),e.jsx("p",{className:"text-neutral-500 mt-1",children:"Vous n'avez aucune livraison à confirmer pour le moment."})]}):e.jsx("div",{className:"space-y-4",children:n.map(r=>e.jsx(K,{transaction:r,onConfirmed:t},r.id))})}function me(){const{user:s,profile:n}=v(),{balance:m,loading:d}=P(),[l,c]=A.useState([]);A.useEffect(()=>{if(!s)return;(async()=>{const{data:r,error:o}=await h.from("transactions").select("id, shipments(title)").eq("status","COMPLETED").or(`sender_id.eq.${s.id},traveler_id.eq.${s.id}`);if(!o&&r){const u=r.map(j=>j.id),{data:x}=await h.from("reviews").select("transaction_id").in("transaction_id",u).eq("reviewer_id",s.id),p=new Set(x==null?void 0:x.map(j=>j.transaction_id)),w=r.map(j=>({...j,review_left:p.has(j.id)}));c(w)}})()},[s]);const i=(n==null?void 0:n.role)==="ADMIN"||(n==null?void 0:n.role)==="MODERATOR";return e.jsx("div",{className:"min-h-screen bg-neutral-50 py-12 px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl md:text-4xl font-bold text-neutral-800",children:"Votre Tableau de Bord"}),e.jsxs("p",{className:"text-lg text-neutral-600 mt-2",children:["Bienvenue, ",(n==null?void 0:n.first_name)||(s==null?void 0:s.email)," !"]})]}),e.jsxs("div",{className:"flex flex-wrap gap-4 mt-4 sm:mt-0",children:[e.jsx(g,{to:"/create-trip",children:e.jsxs(f,{size:"lg",variant:"outline",children:[e.jsx(k,{className:"w-5 h-5 mr-2"}),"Proposer un voyage"]})}),e.jsx(g,{to:"/create-shipment",children:e.jsxs(f,{size:"lg",className:"bg-primary hover:bg-primary/90 text-white",children:[e.jsx(k,{className:"w-5 h-5 mr-2"}),"Publier une annonce"]})})]})]}),i&&e.jsx("div",{className:"mb-8",children:e.jsx(g,{to:"/admin",children:e.jsxs(f,{size:"lg",className:"w-full bg-accent hover:bg-accent/90 text-white",children:[e.jsx(O,{className:"w-5 h-5 mr-2"}),"Accéder au Panneau d'Administration"]})})}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-lg p-6 flex items-center justify-between mb-8 border border-primary/20",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-neutral-500",children:"Votre solde de tokens"}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(R,{className:"w-6 h-6 text-primary"}),e.jsx("span",{className:"text-3xl font-bold text-neutral-800",children:d?e.jsx(N,{className:"w-6 h-6 animate-spin"}):m})]})]}),e.jsx(g,{to:"/buy-tokens",children:e.jsxs(f,{variant:"outline",children:[e.jsx(F,{className:"w-4 h-4 mr-2"}),"Recharger"]})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"bg-white rounded-4xl shadow-xl p-8",children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsx(D,{className:"w-6 h-6 text-primary mr-3"}),e.jsx("h2",{className:"text-2xl font-bold text-neutral-800",children:"Confirmations en attente"})]}),e.jsx(Q,{})]}),e.jsxs("div",{className:"bg-white rounded-4xl shadow-xl p-8",children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsx(q,{className:"w-6 h-6 text-primary mr-3"}),e.jsx("h2",{className:"text-2xl font-bold text-neutral-800",children:"Mes Offres Reçues"})]}),e.jsx(G,{})]}),e.jsxs("div",{className:"bg-white rounded-4xl shadow-xl p-8",children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsx(B,{className:"w-6 h-6 text-primary mr-3"}),e.jsx("h2",{className:"text-2xl font-bold text-neutral-800",children:"Historique des transactions"})]}),e.jsx("div",{className:"space-y-4",children:l.length>0?l.map(t=>e.jsxs("div",{className:"flex justify-between items-center bg-neutral-50 p-4 rounded-lg",children:[e.jsxs("p",{className:"text-neutral-700",children:['Colis: "',t.shipments.title,'"']}),!t.review_left&&e.jsx(g,{to:`/leave-review/${t.id}`,children:e.jsxs(f,{variant:"outline",size:"sm",className:"border-primary text-primary hover:bg-primary/10",children:[e.jsx(U,{className:"w-4 h-4 mr-2"}),"Laisser un avis"]})})]},t.id)):e.jsx("p",{className:"text-neutral-500 text-center py-4",children:"Aucune transaction terminée."})})]})]}),e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"bg-white rounded-4xl shadow-xl p-8",children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsx(M,{className:"w-6 h-6 text-primary mr-3"}),e.jsx("h2",{className:"text-2xl font-bold text-neutral-800",children:"Mes Transports à Venir"})]}),e.jsx(J,{})]}),e.jsxs("div",{className:"bg-white rounded-4xl shadow-xl p-8",children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsx(y,{className:"w-6 h-6 text-primary mr-3"}),e.jsx("h2",{className:"text-2xl font-bold text-neutral-800",children:"Mes Annonces de Colis"})]}),e.jsx($,{})]})]})]})]})})}export{me as DashboardPage};
